create view "dbt_dev"."scd_policy__dbt_tmp" as
    -- This file is automatically generated


with

policy as (
    select * from "IGI_PROD_DW"."dbo"."Policy"
),

ordered as (
    select
        lPolicyKey,
        lPolicyFolderKey,
        lActivePolicyActivityKey,
        sPolicyNo,
        sQuoteNo,
        nVersion,
        lInsuredContactKey,
        dtPeriodFrom,
        dtPeriodTo,
        dtPeriodToDisplay,
        dtPeriodToOriginal,
        dtPeriodToDisplayOriginal,
        nPeriodFromYear,
        bPeriodTBA,
        bMidnightStartTime,
        dtCancel,
        lPolicyCurrencyKey,
        dROE,
        bRenewalCreated,
        lRenewalPolicyKey,
        dtUltimateExpiryDate,
        sPreviousYearPolicyNo,
        lTypeOfPolicyKey,
        bConvertedPolicy,
        lNewBusRenewPolicyActivityKey,
        lCorrAnchorPolicyActivityKey,
        bCloneComplete,
        lProgramFolderKey,
        lProgramYearKey,
        bCreateDecFrom,
        lMasterPolicyKey,
        dtMasterPeriodFrom,
        dtMasterPeriodTo,
        nNextDeclaration,
        nDec,
        lActiveEndorsementActivityKey,
        dt1stWritten,
        lMasterPolicyFolderKey,
        bOriginalPolicy,
        nPreviousVersion,
        lTypeofTBAPeriodKey,
        nNumberOfMonths,
        sReference,
        bRegenerateReference,
        lPresentationCurrencyKey,
        bCopyCreated,
        bReplacementEndorsements,
        sSubmissionNo,
        sBoundNo,
        nNextClaimNo,
        lPolicyLineChainKey,
        bSkeleton,
        lProducerContactKey,
        lReinsuredContactKey,
        lBrokerContactKey,
        sUMR,
        bAdjustable,
        dtAdjustable,
        bAdjusted,
        bTreaty,
        lEndorementSubClassificationKey,
        bIsSequence,
        sSequenceCaption,
        bIsFixedROE,
        lTypeOfProfitCentreKey,
        nPeriodDaysPremium,
        lSoapPolicyKey,
        bIntegratedPolicy,
        dw_loadts,
        row_number() over (
            partition by
                lPolicyKey,
                lPolicyFolderKey,
                lActivePolicyActivityKey,
                sPolicyNo,
                sQuoteNo,
                nVersion,
                lInsuredContactKey,
                dtPeriodFrom,
                dtPeriodTo,
                dtPeriodToDisplay,
                dtPeriodToOriginal,
                dtPeriodToDisplayOriginal,
                nPeriodFromYear,
                bPeriodTBA,
                bMidnightStartTime,
                dtCancel,
                lPolicyCurrencyKey,
                dROE,
                bRenewalCreated,
                lRenewalPolicyKey,
                dtUltimateExpiryDate,
                sPreviousYearPolicyNo,
                lTypeOfPolicyKey,
                bConvertedPolicy,
                lNewBusRenewPolicyActivityKey,
                lCorrAnchorPolicyActivityKey,
                bCloneComplete,
                lProgramFolderKey,
                lProgramYearKey,
                bCreateDecFrom,
                lMasterPolicyKey,
                dtMasterPeriodFrom,
                dtMasterPeriodTo,
                nNextDeclaration,
                nDec,
                lActiveEndorsementActivityKey,
                dt1stWritten,
                lMasterPolicyFolderKey,
                bOriginalPolicy,
                nPreviousVersion,
                lTypeofTBAPeriodKey,
                nNumberOfMonths,
                sReference,
                bRegenerateReference,
                lPresentationCurrencyKey,
                bCopyCreated,
                bReplacementEndorsements,
                sSubmissionNo,
                sBoundNo,
                nNextClaimNo,
                lPolicyLineChainKey,
                bSkeleton,
                lProducerContactKey,
                lReinsuredContactKey,
                lBrokerContactKey,
                sUMR,
                bAdjustable,
                dtAdjustable,
                bAdjusted,
                bTreaty,
                lEndorementSubClassificationKey,
                bIsSequence,
                sSequenceCaption,
                bIsFixedROE,
                lTypeOfProfitCentreKey,
                nPeriodDaysPremium,
                lSoapPolicyKey,
                bIntegratedPolicy
            order by
                dw_loadts
        ) as dw_extract_order
    from
        policy
),

filtered as (
    select * from ordered where dw_extract_order = 1
),

ranged as (
    select
        lPolicyKey,
        lPolicyFolderKey,
        lActivePolicyActivityKey,
        sPolicyNo,
        sQuoteNo,
        nVersion,
        lInsuredContactKey,
        dtPeriodFrom,
        dtPeriodTo,
        dtPeriodToDisplay,
        dtPeriodToOriginal,
        dtPeriodToDisplayOriginal,
        nPeriodFromYear,
        bPeriodTBA,
        bMidnightStartTime,
        dtCancel,
        lPolicyCurrencyKey,
        dROE,
        bRenewalCreated,
        lRenewalPolicyKey,
        dtUltimateExpiryDate,
        sPreviousYearPolicyNo,
        lTypeOfPolicyKey,
        bConvertedPolicy,
        lNewBusRenewPolicyActivityKey,
        lCorrAnchorPolicyActivityKey,
        bCloneComplete,
        lProgramFolderKey,
        lProgramYearKey,
        bCreateDecFrom,
        lMasterPolicyKey,
        dtMasterPeriodFrom,
        dtMasterPeriodTo,
        nNextDeclaration,
        nDec,
        lActiveEndorsementActivityKey,
        dt1stWritten,
        lMasterPolicyFolderKey,
        bOriginalPolicy,
        nPreviousVersion,
        lTypeofTBAPeriodKey,
        nNumberOfMonths,
        sReference,
        bRegenerateReference,
        lPresentationCurrencyKey,
        bCopyCreated,
        bReplacementEndorsements,
        sSubmissionNo,
        sBoundNo,
        nNextClaimNo,
        lPolicyLineChainKey,
        bSkeleton,
        lProducerContactKey,
        lReinsuredContactKey,
        lBrokerContactKey,
        sUMR,
        bAdjustable,
        dtAdjustable,
        bAdjusted,
        bTreaty,
        lEndorementSubClassificationKey,
        bIsSequence,
        sSequenceCaption,
        bIsFixedROE,
        lTypeOfProfitCentreKey,
        nPeriodDaysPremium,
        lSoapPolicyKey,
        bIntegratedPolicy,
        dw_loadts as _valid_from,
        lead(dw_loadts) over (partition by lPolicyKey order by dw_loadts) as _valid_to
    from
        filtered
)

select * from ranged
