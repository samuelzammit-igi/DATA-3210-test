-- This file is automatically generated


with

apr as (
    select * from "IGI_PROD_DW"."dbo"."AccountsPayableReceivable"
),

ordered as (
    select
        lAccountsPayableReceivableKey,
        lTypeOfAccountActivityKey,
        lTypeOfPayableReceivableKey,
        sReference,
        lEntityKey,
        lInstanceKey,
        lParentEntityKey,
        lParentInstanceKey,
        sInstanceReference,
        lAccountPeriodKey,
        dtEntry,
        dtEffective,
        nTermsOfTradeDays,
        dtDue,
        lTypeOfPayMethodKey,
        lPayerContactKey,
        lPayeeContactKey,
        lInRespectOfContactKey,
        lPayerContactBankKey,
        lPayeeContactBankKey,
        lCurrencyKey,
        dROE,
        dAmount,
        dAllocated,
        dUnallocated,
        bRecordPaymentDetails,
        dtPaymentMade,
        sPaymentReference,
        lNotesKey,
        lTransactionGroup,
        lDependentAPRKey,
        lParentAPRKey,
        bAvailableForUserMatching,
        lCashMatchingContactKey,
        lSourceEntityKey,
        lSourceInstanceKey,
        lDivisionKey,
        lTypeOfMonetaryAmountKey,
        sNotes,
        bAutoNetted,
        dNetReceiveableAmount,
        bCashLoss,
        bCashLossIndicator,
        dBaseAmount,
        lBaseCurrencyKey,
        lPolicyAPRGroupKey,
        lENDSubClassificationKey,
        dNetReceivableAmountUSD,
        dw_loadts,
        row_number() over (
            partition by
                lAccountsPayableReceivableKey,
                lTypeOfAccountActivityKey,
                lTypeOfPayableReceivableKey,
                sReference,
                lEntityKey,
                lInstanceKey,
                lParentEntityKey,
                lParentInstanceKey,
                sInstanceReference,
                lAccountPeriodKey,
                dtEntry,
                dtEffective,
                nTermsOfTradeDays,
                dtDue,
                lTypeOfPayMethodKey,
                lPayerContactKey,
                lPayeeContactKey,
                lInRespectOfContactKey,
                lPayerContactBankKey,
                lPayeeContactBankKey,
                lCurrencyKey,
                dROE,
                dAmount,
                dAllocated,
                dUnallocated,
                bRecordPaymentDetails,
                dtPaymentMade,
                sPaymentReference,
                lNotesKey,
                lTransactionGroup,
                lDependentAPRKey,
                lParentAPRKey,
                bAvailableForUserMatching,
                lCashMatchingContactKey,
                lSourceEntityKey,
                lSourceInstanceKey,
                lDivisionKey,
                lTypeOfMonetaryAmountKey,
                sNotes,
                bAutoNetted,
                dNetReceiveableAmount,
                bCashLoss,
                bCashLossIndicator,
                dBaseAmount,
                lBaseCurrencyKey,
                lPolicyAPRGroupKey,
                lENDSubClassificationKey,
                dNetReceivableAmountUSD
            order by
                dw_loadts
        ) as dw_extract_order
    from
        apr
),

filtered as (
    select * from ordered where dw_extract_order = 1
),

ranged as (
    select
        lAccountsPayableReceivableKey,
        lTypeOfAccountActivityKey,
        lTypeOfPayableReceivableKey,
        sReference,
        lEntityKey,
        lInstanceKey,
        lParentEntityKey,
        lParentInstanceKey,
        sInstanceReference,
        lAccountPeriodKey,
        dtEntry,
        dtEffective,
        nTermsOfTradeDays,
        dtDue,
        lTypeOfPayMethodKey,
        lPayerContactKey,
        lPayeeContactKey,
        lInRespectOfContactKey,
        lPayerContactBankKey,
        lPayeeContactBankKey,
        lCurrencyKey,
        dROE,
        dAmount,
        dAllocated,
        dUnallocated,
        bRecordPaymentDetails,
        dtPaymentMade,
        sPaymentReference,
        lNotesKey,
        lTransactionGroup,
        lDependentAPRKey,
        lParentAPRKey,
        bAvailableForUserMatching,
        lCashMatchingContactKey,
        lSourceEntityKey,
        lSourceInstanceKey,
        lDivisionKey,
        lTypeOfMonetaryAmountKey,
        sNotes,
        bAutoNetted,
        dNetReceiveableAmount,
        bCashLoss,
        bCashLossIndicator,
        dBaseAmount,
        lBaseCurrencyKey,
        lPolicyAPRGroupKey,
        lENDSubClassificationKey,
        dNetReceivableAmountUSD,
        dw_loadts as _valid_from,
        lead(dw_loadts) over (partition by lAccountsPayableReceivableKey order by dw_loadts) as _valid_to
    from
        filtered
)

select * from ranged