-- This file is automatically generated


with

apr_message_instalment as (
    select * from "IGI_PROD_DW"."dbo"."APRMessageInstalment"
),

ordered as (
    select
        lAPRMessageInstalmentkey,
        lAPRMessageHeaderKey,
        lAccountsPayableReceivableKey,
        bTreatySection,
        lOriginalCurrencyKey,
        lSettlementCurrencyKey,
        dMessageOrigSettRoe,
        dtSettlementDue,
        dtActualPayment,
        dPayMessageInstalmentSettShare,
        nInstalment,
        lPaymentTypeClassKey,
        lStagingTableInstalmentKey,
        lBureauMessageKey,
        lTypeOfBureauMessageKey,
        sTransactionUUId,
        sServiceProviderAccountTR,
        sCedentTransRef,
        sBrokerReference1,
        sBrokerReference2,
        lAccountPeriodKey,
        lSourceEntityKey,
        dDiff,
        lTypeOfTechnicalCategoryKey,
        dw_loadts,
        row_number() over (
            partition by
                lAPRMessageInstalmentkey,
                lAPRMessageHeaderKey,
                lAccountsPayableReceivableKey,
                bTreatySection,
                lOriginalCurrencyKey,
                lSettlementCurrencyKey,
                dMessageOrigSettRoe,
                dtSettlementDue,
                dtActualPayment,
                dPayMessageInstalmentSettShare,
                nInstalment,
                lPaymentTypeClassKey,
                lStagingTableInstalmentKey,
                lBureauMessageKey,
                lTypeOfBureauMessageKey,
                sTransactionUUId,
                sServiceProviderAccountTR,
                sCedentTransRef,
                sBrokerReference1,
                sBrokerReference2,
                lAccountPeriodKey,
                lSourceEntityKey,
                dDiff,
                lTypeOfTechnicalCategoryKey
            order by
                dw_loadts
        ) as dw_extract_order
    from
        apr_message_instalment
),

filtered as (
    select * from ordered where dw_extract_order = 1
),

ranged as (
    select
        lAPRMessageInstalmentkey,
        lAPRMessageHeaderKey,
        lAccountsPayableReceivableKey,
        bTreatySection,
        lOriginalCurrencyKey,
        lSettlementCurrencyKey,
        dMessageOrigSettRoe,
        dtSettlementDue,
        dtActualPayment,
        dPayMessageInstalmentSettShare,
        nInstalment,
        lPaymentTypeClassKey,
        lStagingTableInstalmentKey,
        lBureauMessageKey,
        lTypeOfBureauMessageKey,
        sTransactionUUId,
        sServiceProviderAccountTR,
        sCedentTransRef,
        sBrokerReference1,
        sBrokerReference2,
        lAccountPeriodKey,
        lSourceEntityKey,
        dDiff,
        lTypeOfTechnicalCategoryKey,
        dw_loadts as _valid_from,
        lead(dw_loadts) over (partition by lAPRMessageInstalmentkey order by dw_loadts) as _valid_to
    from
        filtered
)

select * from ranged