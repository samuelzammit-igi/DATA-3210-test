-- This file is automatically generated



with

policy_activity as (
    select * from "IGI_PROD_DW"."dbo"."PolicyActivity"
),

ordered as (
    select
        lPolicyActivityKey,
        lPolicyKey,
        lPolicyFolderKey,
        lTypeOfPolicyActivityKey,
        lTypeOfEndorsementKey,
        lTypeOfCorrectionKey,
        nVersion,
        lAuthorityCheckJoinKey,
        lBoundAccountPeriodKey,
        lWrittenAccountPeriodKey,
        lSignedAccountPeriodKey,
        dtCreated,
        sPolicyNo,
        sQuoteNo,
        dtPeriodFrom,
        dtPeriodTo,
        dtPeriodToDisplay,
        dtPeriodToTruncated,
        nPeriodDaysPremium,
        nPeriodDaysTruncated,
        nPeriodDaysEarning,
        bFullySuperceded,
        bPeriodTBA,
        dtSubmissionReceived,
        dtSubmissionRespondBy,
        dtQuoted,
        dtQuoteOpenUntil,
        bPriorActs,
        dtRetroactiveDate,
        dtTailEffectiveDate,
        dtTailExpiryDate,
        bMidnightStartTime,
        dtNoticeOfCancellation,
        nNoticeOfCancellationDays,
        dtCancel,
        lTypeOfCancellationKey,
        lTypeOfCancelledByKey,
        lPolicyActivityCurrencyKey,
        dROE,
        bSingleMarket,
        bDeclaration,
        lTypeOfPlacementKey,
        bEndorsing,
        bPartSigned,
        lBrokerContactKey,
        lBrokerLiaisonKey,
        sBrokerReference,
        lInsuredContactKey,
        lTypeOfSICKey,
        dtPriorAndPendingLitigation,
        lTypeOfFSACategoryKey,
        sSubmissionDescription,
        dPeriodAnnualFactor,
        lAgreementFolderKey,
        lAgreementYearKey,
        lAgreementActivityKey,
        lAgreementPeriodKey,
        lAgreementContactKey,
        lAgreementContactBranchKey,
        lTypeOfInsuranceKey,
        lReinsuredContactKey,
        bDelinked,
        dCancelRateFactor,
        bCloneComplete,
        bCreateFac,
        bFacCreated,
        lAutoCreatedFacRIFolderKey,
        lSurplusBrokerContactKey,
        lSurplusBrokerLiaisonKey,
        lTypeOfSurplusLineIndicatorKey,
        sSurplusLineLicenseNoBroker,
        sSurplusLineCertificatNoBroker,
        bCopiedVersion,
        lProductKey,
        nCountCancellationReason,
        nCountNonRenewReason,
        nCountReinstatementReason,
        nCountDeclinedReason,
        nCountQuoteDeclinedReason,
        lSurplusLineStateKey,
        lAccountContactKey,
        lProductVersionCarrierKey,
        lProductVersionTemplateKey,
        bInPeerReview,
        bPeerReviewComplete,
        dtPeerReviewComplete,
        nPeerReviewUnderwritersReqd,
        nCountPeerReviewComplete,
        bRunOffPolicy,
        lExpiringInsurerContactKey,
        sExpiringInsurerReference,
        lSecondaryBrokerContactKey,
        lSecondBrokerContactLiaisonkey,
        dtIssuanceReviewed,
        sSurplusLineAddress1,
        sSurplusLineAddress2,
        sSurplusLineCity,
        sSurplusLinePostCode,
        sSurplusLinePhone,
        sSurplusLineLicenseNoAgent,
        sSurplusLineCertificateNoAgent,
        sIssuanceAddressTo,
        sIssuanceAddress1,
        sIssuanceAddress2,
        sIssuanceAddressCity,
        lIssuanceAddressStateKey,
        sIssuanceAddressPostCode,
        lTypeOfAdmittedKey,
        sSecondaryBrokerContact,
        sSecondaryBrokerContactLiaison,
        bConvertedPolicy,
        bProductImported,
        bIssuanceAddressSameAsInsureds,
        bNonRenew,
        lProducingOfficekey,
        lPolicyClassKey,
        sUMR,
        sPolicyDescription,
        lContractCertainKey,
        dtWorksExpiryDate,
        bIsContra,
        nMaximumPeriod,
        lProgramFolderKey,
        lProgramYearKey,
        bQuoteNTUReasonEntered,
        bUndoQuoteNTUReasonEntered,
        lUWHoldingContactKey,
        nProductVersion,
        lProductTemplateSectionAddkey,
        lLawCountryKey,
        lJurisdictionCountryKey,
        sLocalReference,
        lInsuredDomicileCountryKey,
        lInsuredDomicileStatekey,
        sInsuredPerContractWording,
        bProductRuleResult,
        lInforceAccumulationReportKey,
        lQuoteAccumulationReportKey,
        bCopyMasterCoverOntoDec,
        lDeclarationProductKey,
        bPolicyIsTransitBased,
        bAuthorisationResult,
        bMasterPolicyUpdated,
        bProductHardRuleResult,
        nDefaultQuoteDays,
        lServiceofSuitKey,
        lCreatedBy,
        bLocationBasedProduct,
        bProcessDeductions,
        nUnassignedUnderwriters,
        bUseAccountSubmission,
        lCloneParentKey,
        lTypeOfProductGroupKey,
        nNumberOfLines,
        lTypeofUSClassificationKey,
        lJurisdictionStateKey,
        lSurplusLineCountryKey,
        bRenewalFlagProperty,
        dtAgreementPeriodToMax,
        bAuthorisedBroker,
        bAgreementCountryScopeWrldwide,
        nNullAgreementSections,
        bMarketSourceIsMessaging,
        lCoverholderContactKey,
        bRiskBordereau,
        bClaimBordereau,
        bPremiumBordereau,
        lTypeofReportingBasis,
        lReportingFrequency,
        bOnAgreement,
        lMasterPolicyActivityKey,
        bBinderPolicy,
        nNumberOfSections,
        lMasterPolicySectionToAddKey,
        bBinderHasCountryScope,
        bBinderHasCurrencyScope,
        dtMaximumExpiryDate,
        bBinderScopeSubCodesRequired,
        bLloydsBordereau,
        sContactAddress1,
        sContactAddress2,
        sContactAddressCity,
        sContactAddressPostCode,
        lContactAddressStateKey,
        sContactAddressTo,
        bLinesWritten,
        lPolicySummaryViewScreenKey,
        nLinesVoidedorSigned,
        bPassThroughWritten,
        lTypeOfIndustryVerticalKey,
        lImplementationSetupForNewOldRIKey,
        bEnableNewRI,
        bAuthorisedSurplusBroker,
        bAuthorisedSecondaryBroker,
        lTypeOfCancellationReasonKey,
        dtLastVerEffectiveDate,
        dtReinstatementDate,
        sSurplusLinesSLANumber,
        dtPolicyIssuedDate,
        sOverridePolicyReference,
        bAllowOverridePolicyReference,
        nTotalBinderProportionPc,
        nCountLinesSigned,
        bRunPropRIGeneration,
        bRIProfileEdited,
        bReferenceUnique,
        LTypeofRefError,
        lTypeofInsuredPolicyholderLloyds,
        nInsuredTotalNumberofEmployees,
        dInsuredRevenueTurnover,
        bReferredToLondon,
        bIsCountryinEEA,
        nCountCodeSplitsNotDone,
        bPeriodReturnEndorsement,
        bContraPeriodValueReturn,
        dReplaceGrossForPeriod,
        nDaysPolicyFromActivityExp,
        bAggregationRequired,
        bEndorsementAggregationRequired,
        bDeclarationException,
        bDeclarationExceptionApproved,
        LMAJORTERRITORYKEY,
        LTERRITORYKEY,
        sSubmissionNo,
        sBoundNo,
        lProducerContactKey,
        bInsuredPossibleDuplicate,
        dtPhase1From,
        dtPhase1To,
        dPhase1PC,
        dtPhase2From,
        dtPhase2To,
        dPhase2PC,
        dtPhase3From,
        dtPhase3To,
        dPhase3PC,
        nEarningPeriodDays,
        bFailedComplianceChecks,
        bComplianceChecksOverride,
        lTypeofActivitySourceKey,
        nBrokerVersionNumber,
        bBound,
        lTypeOFMasterFacilityKey,
        lTypeOFFacilityKey,
        lTypeOFAuthorityLevelKey,
        lTypeOFSettlementKey,
        bTreaty,
        lQuoted,
        lOfferValidityPeriod,
        dtFinalslipReceived,
        bRIAutoProfilingRequired,
        sNotes,
        lEndorementSubClassificationKey,
        sAssuredDescription,
        bIsReversal,
        bIsFixedROE,
        lCurrentPolicyCurrencyKey,
        dCurrentCurrencyROE,
        nCountAgencyFees,
        bFailedLegalChecks,
        bLegalChecksOverride,
        bSubmissionReviewCreated,
        dtWrittenDate,
        lIsBound,
        bPremiumAuthorized,
        bRequiresKYCDivision,
        bAgnecyFeesAmountTrigger,
        bAgnecyFeesTypeTrigger,
        bAgnecyFeesOrderTrigger,
        bAgnecyFeesIncompatibleTrigger,
        bAgnecyFeesOverwriteTrigger,
        bCoverageElementRequired,
        bEnableClassonCFI,
        dw_loadts,
        row_number() over (
            partition by
                lPolicyActivityKey,
                lPolicyKey,
                lPolicyFolderKey,
                lTypeOfPolicyActivityKey,
                lTypeOfEndorsementKey,
                lTypeOfCorrectionKey,
                nVersion,
                lAuthorityCheckJoinKey,
                lBoundAccountPeriodKey,
                lWrittenAccountPeriodKey,
                lSignedAccountPeriodKey,
                dtCreated,
                sPolicyNo,
                sQuoteNo,
                dtPeriodFrom,
                dtPeriodTo,
                dtPeriodToDisplay,
                dtPeriodToTruncated,
                nPeriodDaysPremium,
                nPeriodDaysTruncated,
                nPeriodDaysEarning,
                bFullySuperceded,
                bPeriodTBA,
                dtSubmissionReceived,
                dtSubmissionRespondBy,
                dtQuoted,
                dtQuoteOpenUntil,
                bPriorActs,
                dtRetroactiveDate,
                dtTailEffectiveDate,
                dtTailExpiryDate,
                bMidnightStartTime,
                dtNoticeOfCancellation,
                nNoticeOfCancellationDays,
                dtCancel,
                lTypeOfCancellationKey,
                lTypeOfCancelledByKey,
                lPolicyActivityCurrencyKey,
                dROE,
                bSingleMarket,
                bDeclaration,
                lTypeOfPlacementKey,
                bEndorsing,
                bPartSigned,
                lBrokerContactKey,
                lBrokerLiaisonKey,
                sBrokerReference,
                lInsuredContactKey,
                lTypeOfSICKey,
                dtPriorAndPendingLitigation,
                lTypeOfFSACategoryKey,
                sSubmissionDescription,
                dPeriodAnnualFactor,
                lAgreementFolderKey,
                lAgreementYearKey,
                lAgreementActivityKey,
                lAgreementPeriodKey,
                lAgreementContactKey,
                lAgreementContactBranchKey,
                lTypeOfInsuranceKey,
                lReinsuredContactKey,
                bDelinked,
                dCancelRateFactor,
                bCloneComplete,
                bCreateFac,
                bFacCreated,
                lAutoCreatedFacRIFolderKey,
                lSurplusBrokerContactKey,
                lSurplusBrokerLiaisonKey,
                lTypeOfSurplusLineIndicatorKey,
                sSurplusLineLicenseNoBroker,
                sSurplusLineCertificatNoBroker,
                bCopiedVersion,
                lProductKey,
                nCountCancellationReason,
                nCountNonRenewReason,
                nCountReinstatementReason,
                nCountDeclinedReason,
                nCountQuoteDeclinedReason,
                lSurplusLineStateKey,
                lAccountContactKey,
                lProductVersionCarrierKey,
                lProductVersionTemplateKey,
                bInPeerReview,
                bPeerReviewComplete,
                dtPeerReviewComplete,
                nPeerReviewUnderwritersReqd,
                nCountPeerReviewComplete,
                bRunOffPolicy,
                lExpiringInsurerContactKey,
                sExpiringInsurerReference,
                lSecondaryBrokerContactKey,
                lSecondBrokerContactLiaisonkey,
                dtIssuanceReviewed,
                sSurplusLineAddress1,
                sSurplusLineAddress2,
                sSurplusLineCity,
                sSurplusLinePostCode,
                sSurplusLinePhone,
                sSurplusLineLicenseNoAgent,
                sSurplusLineCertificateNoAgent,
                sIssuanceAddressTo,
                sIssuanceAddress1,
                sIssuanceAddress2,
                sIssuanceAddressCity,
                lIssuanceAddressStateKey,
                sIssuanceAddressPostCode,
                lTypeOfAdmittedKey,
                sSecondaryBrokerContact,
                sSecondaryBrokerContactLiaison,
                bConvertedPolicy,
                bProductImported,
                bIssuanceAddressSameAsInsureds,
                bNonRenew,
                lProducingOfficekey,
                lPolicyClassKey,
                sUMR,
                sPolicyDescription,
                lContractCertainKey,
                dtWorksExpiryDate,
                bIsContra,
                nMaximumPeriod,
                lProgramFolderKey,
                lProgramYearKey,
                bQuoteNTUReasonEntered,
                bUndoQuoteNTUReasonEntered,
                lUWHoldingContactKey,
                nProductVersion,
                lProductTemplateSectionAddkey,
                lLawCountryKey,
                lJurisdictionCountryKey,
                sLocalReference,
                lInsuredDomicileCountryKey,
                lInsuredDomicileStatekey,
                sInsuredPerContractWording,
                bProductRuleResult,
                lInforceAccumulationReportKey,
                lQuoteAccumulationReportKey,
                bCopyMasterCoverOntoDec,
                lDeclarationProductKey,
                bPolicyIsTransitBased,
                bAuthorisationResult,
                bMasterPolicyUpdated,
                bProductHardRuleResult,
                nDefaultQuoteDays,
                lServiceofSuitKey,
                lCreatedBy,
                bLocationBasedProduct,
                bProcessDeductions,
                nUnassignedUnderwriters,
                bUseAccountSubmission,
                lCloneParentKey,
                lTypeOfProductGroupKey,
                nNumberOfLines,
                lTypeofUSClassificationKey,
                lJurisdictionStateKey,
                lSurplusLineCountryKey,
                bRenewalFlagProperty,
                dtAgreementPeriodToMax,
                bAuthorisedBroker,
                bAgreementCountryScopeWrldwide,
                nNullAgreementSections,
                bMarketSourceIsMessaging,
                lCoverholderContactKey,
                bRiskBordereau,
                bClaimBordereau,
                bPremiumBordereau,
                lTypeofReportingBasis,
                lReportingFrequency,
                bOnAgreement,
                lMasterPolicyActivityKey,
                bBinderPolicy,
                nNumberOfSections,
                lMasterPolicySectionToAddKey,
                bBinderHasCountryScope,
                bBinderHasCurrencyScope,
                dtMaximumExpiryDate,
                bBinderScopeSubCodesRequired,
                bLloydsBordereau,
                sContactAddress1,
                sContactAddress2,
                sContactAddressCity,
                sContactAddressPostCode,
                lContactAddressStateKey,
                sContactAddressTo,
                bLinesWritten,
                lPolicySummaryViewScreenKey,
                nLinesVoidedorSigned,
                bPassThroughWritten,
                lTypeOfIndustryVerticalKey,
                lImplementationSetupForNewOldRIKey,
                bEnableNewRI,
                bAuthorisedSurplusBroker,
                bAuthorisedSecondaryBroker,
                lTypeOfCancellationReasonKey,
                dtLastVerEffectiveDate,
                dtReinstatementDate,
                sSurplusLinesSLANumber,
                dtPolicyIssuedDate,
                sOverridePolicyReference,
                bAllowOverridePolicyReference,
                nTotalBinderProportionPc,
                nCountLinesSigned,
                bRunPropRIGeneration,
                bRIProfileEdited,
                bReferenceUnique,
                LTypeofRefError,
                lTypeofInsuredPolicyholderLloyds,
                nInsuredTotalNumberofEmployees,
                dInsuredRevenueTurnover,
                bReferredToLondon,
                bIsCountryinEEA,
                nCountCodeSplitsNotDone,
                bPeriodReturnEndorsement,
                bContraPeriodValueReturn,
                dReplaceGrossForPeriod,
                nDaysPolicyFromActivityExp,
                bAggregationRequired,
                bEndorsementAggregationRequired,
                bDeclarationException,
                bDeclarationExceptionApproved,
                LMAJORTERRITORYKEY,
                LTERRITORYKEY,
                sSubmissionNo,
                sBoundNo,
                lProducerContactKey,
                bInsuredPossibleDuplicate,
                dtPhase1From,
                dtPhase1To,
                dPhase1PC,
                dtPhase2From,
                dtPhase2To,
                dPhase2PC,
                dtPhase3From,
                dtPhase3To,
                dPhase3PC,
                nEarningPeriodDays,
                bFailedComplianceChecks,
                bComplianceChecksOverride,
                lTypeofActivitySourceKey,
                nBrokerVersionNumber,
                bBound,
                lTypeOFMasterFacilityKey,
                lTypeOFFacilityKey,
                lTypeOFAuthorityLevelKey,
                lTypeOFSettlementKey,
                bTreaty,
                lQuoted,
                lOfferValidityPeriod,
                dtFinalslipReceived,
                bRIAutoProfilingRequired,
                sNotes,
                lEndorementSubClassificationKey,
                sAssuredDescription,
                bIsReversal,
                bIsFixedROE,
                lCurrentPolicyCurrencyKey,
                dCurrentCurrencyROE,
                nCountAgencyFees,
                bFailedLegalChecks,
                bLegalChecksOverride,
                bSubmissionReviewCreated,
                dtWrittenDate,
                lIsBound,
                bPremiumAuthorized,
                bRequiresKYCDivision,
                bAgnecyFeesAmountTrigger,
                bAgnecyFeesTypeTrigger,
                bAgnecyFeesOrderTrigger,
                bAgnecyFeesIncompatibleTrigger,
                bAgnecyFeesOverwriteTrigger,
                bCoverageElementRequired,
                bEnableClassonCFI
            order by
                dw_loadts
        ) as dw_extract_order
    from
        policy_activity
),

filtered as (
    select * from ordered where dw_extract_order = 1
),

ranged as (
    select
        lPolicyActivityKey,
        lPolicyKey,
        lPolicyFolderKey,
        lTypeOfPolicyActivityKey,
        lTypeOfEndorsementKey,
        lTypeOfCorrectionKey,
        nVersion,
        lAuthorityCheckJoinKey,
        lBoundAccountPeriodKey,
        lWrittenAccountPeriodKey,
        lSignedAccountPeriodKey,
        dtCreated,
        sPolicyNo,
        sQuoteNo,
        dtPeriodFrom,
        dtPeriodTo,
        dtPeriodToDisplay,
        dtPeriodToTruncated,
        nPeriodDaysPremium,
        nPeriodDaysTruncated,
        nPeriodDaysEarning,
        bFullySuperceded,
        bPeriodTBA,
        dtSubmissionReceived,
        dtSubmissionRespondBy,
        dtQuoted,
        dtQuoteOpenUntil,
        bPriorActs,
        dtRetroactiveDate,
        dtTailEffectiveDate,
        dtTailExpiryDate,
        bMidnightStartTime,
        dtNoticeOfCancellation,
        nNoticeOfCancellationDays,
        dtCancel,
        lTypeOfCancellationKey,
        lTypeOfCancelledByKey,
        lPolicyActivityCurrencyKey,
        dROE,
        bSingleMarket,
        bDeclaration,
        lTypeOfPlacementKey,
        bEndorsing,
        bPartSigned,
        lBrokerContactKey,
        lBrokerLiaisonKey,
        sBrokerReference,
        lInsuredContactKey,
        lTypeOfSICKey,
        dtPriorAndPendingLitigation,
        lTypeOfFSACategoryKey,
        sSubmissionDescription,
        dPeriodAnnualFactor,
        lAgreementFolderKey,
        lAgreementYearKey,
        lAgreementActivityKey,
        lAgreementPeriodKey,
        lAgreementContactKey,
        lAgreementContactBranchKey,
        lTypeOfInsuranceKey,
        lReinsuredContactKey,
        bDelinked,
        dCancelRateFactor,
        bCloneComplete,
        bCreateFac,
        bFacCreated,
        lAutoCreatedFacRIFolderKey,
        lSurplusBrokerContactKey,
        lSurplusBrokerLiaisonKey,
        lTypeOfSurplusLineIndicatorKey,
        sSurplusLineLicenseNoBroker,
        sSurplusLineCertificatNoBroker,
        bCopiedVersion,
        lProductKey,
        nCountCancellationReason,
        nCountNonRenewReason,
        nCountReinstatementReason,
        nCountDeclinedReason,
        nCountQuoteDeclinedReason,
        lSurplusLineStateKey,
        lAccountContactKey,
        lProductVersionCarrierKey,
        lProductVersionTemplateKey,
        bInPeerReview,
        bPeerReviewComplete,
        dtPeerReviewComplete,
        nPeerReviewUnderwritersReqd,
        nCountPeerReviewComplete,
        bRunOffPolicy,
        lExpiringInsurerContactKey,
        sExpiringInsurerReference,
        lSecondaryBrokerContactKey,
        lSecondBrokerContactLiaisonkey,
        dtIssuanceReviewed,
        sSurplusLineAddress1,
        sSurplusLineAddress2,
        sSurplusLineCity,
        sSurplusLinePostCode,
        sSurplusLinePhone,
        sSurplusLineLicenseNoAgent,
        sSurplusLineCertificateNoAgent,
        sIssuanceAddressTo,
        sIssuanceAddress1,
        sIssuanceAddress2,
        sIssuanceAddressCity,
        lIssuanceAddressStateKey,
        sIssuanceAddressPostCode,
        lTypeOfAdmittedKey,
        sSecondaryBrokerContact,
        sSecondaryBrokerContactLiaison,
        bConvertedPolicy,
        bProductImported,
        bIssuanceAddressSameAsInsureds,
        bNonRenew,
        lProducingOfficekey,
        lPolicyClassKey,
        sUMR,
        sPolicyDescription,
        lContractCertainKey,
        dtWorksExpiryDate,
        bIsContra,
        nMaximumPeriod,
        lProgramFolderKey,
        lProgramYearKey,
        bQuoteNTUReasonEntered,
        bUndoQuoteNTUReasonEntered,
        lUWHoldingContactKey,
        nProductVersion,
        lProductTemplateSectionAddkey,
        lLawCountryKey,
        lJurisdictionCountryKey,
        sLocalReference,
        lInsuredDomicileCountryKey,
        lInsuredDomicileStatekey,
        sInsuredPerContractWording,
        bProductRuleResult,
        lInforceAccumulationReportKey,
        lQuoteAccumulationReportKey,
        bCopyMasterCoverOntoDec,
        lDeclarationProductKey,
        bPolicyIsTransitBased,
        bAuthorisationResult,
        bMasterPolicyUpdated,
        bProductHardRuleResult,
        nDefaultQuoteDays,
        lServiceofSuitKey,
        lCreatedBy,
        bLocationBasedProduct,
        bProcessDeductions,
        nUnassignedUnderwriters,
        bUseAccountSubmission,
        lCloneParentKey,
        lTypeOfProductGroupKey,
        nNumberOfLines,
        lTypeofUSClassificationKey,
        lJurisdictionStateKey,
        lSurplusLineCountryKey,
        bRenewalFlagProperty,
        dtAgreementPeriodToMax,
        bAuthorisedBroker,
        bAgreementCountryScopeWrldwide,
        nNullAgreementSections,
        bMarketSourceIsMessaging,
        lCoverholderContactKey,
        bRiskBordereau,
        bClaimBordereau,
        bPremiumBordereau,
        lTypeofReportingBasis,
        lReportingFrequency,
        bOnAgreement,
        lMasterPolicyActivityKey,
        bBinderPolicy,
        nNumberOfSections,
        lMasterPolicySectionToAddKey,
        bBinderHasCountryScope,
        bBinderHasCurrencyScope,
        dtMaximumExpiryDate,
        bBinderScopeSubCodesRequired,
        bLloydsBordereau,
        sContactAddress1,
        sContactAddress2,
        sContactAddressCity,
        sContactAddressPostCode,
        lContactAddressStateKey,
        sContactAddressTo,
        bLinesWritten,
        lPolicySummaryViewScreenKey,
        nLinesVoidedorSigned,
        bPassThroughWritten,
        lTypeOfIndustryVerticalKey,
        lImplementationSetupForNewOldRIKey,
        bEnableNewRI,
        bAuthorisedSurplusBroker,
        bAuthorisedSecondaryBroker,
        lTypeOfCancellationReasonKey,
        dtLastVerEffectiveDate,
        dtReinstatementDate,
        sSurplusLinesSLANumber,
        dtPolicyIssuedDate,
        sOverridePolicyReference,
        bAllowOverridePolicyReference,
        nTotalBinderProportionPc,
        nCountLinesSigned,
        bRunPropRIGeneration,
        bRIProfileEdited,
        bReferenceUnique,
        LTypeofRefError,
        lTypeofInsuredPolicyholderLloyds,
        nInsuredTotalNumberofEmployees,
        dInsuredRevenueTurnover,
        bReferredToLondon,
        bIsCountryinEEA,
        nCountCodeSplitsNotDone,
        bPeriodReturnEndorsement,
        bContraPeriodValueReturn,
        dReplaceGrossForPeriod,
        nDaysPolicyFromActivityExp,
        bAggregationRequired,
        bEndorsementAggregationRequired,
        bDeclarationException,
        bDeclarationExceptionApproved,
        LMAJORTERRITORYKEY,
        LTERRITORYKEY,
        sSubmissionNo,
        sBoundNo,
        lProducerContactKey,
        bInsuredPossibleDuplicate,
        dtPhase1From,
        dtPhase1To,
        dPhase1PC,
        dtPhase2From,
        dtPhase2To,
        dPhase2PC,
        dtPhase3From,
        dtPhase3To,
        dPhase3PC,
        nEarningPeriodDays,
        bFailedComplianceChecks,
        bComplianceChecksOverride,
        lTypeofActivitySourceKey,
        nBrokerVersionNumber,
        bBound,
        lTypeOFMasterFacilityKey,
        lTypeOFFacilityKey,
        lTypeOFAuthorityLevelKey,
        lTypeOFSettlementKey,
        bTreaty,
        lQuoted,
        lOfferValidityPeriod,
        dtFinalslipReceived,
        bRIAutoProfilingRequired,
        sNotes,
        lEndorementSubClassificationKey,
        sAssuredDescription,
        bIsReversal,
        bIsFixedROE,
        lCurrentPolicyCurrencyKey,
        dCurrentCurrencyROE,
        nCountAgencyFees,
        bFailedLegalChecks,
        bLegalChecksOverride,
        bSubmissionReviewCreated,
        dtWrittenDate,
        lIsBound,
        bPremiumAuthorized,
        bRequiresKYCDivision,
        bAgnecyFeesAmountTrigger,
        bAgnecyFeesTypeTrigger,
        bAgnecyFeesOrderTrigger,
        bAgnecyFeesIncompatibleTrigger,
        bAgnecyFeesOverwriteTrigger,
        bCoverageElementRequired,
        bEnableClassonCFI,
        dw_loadts as _valid_from,
        lead(dw_loadts) over (partition by lPolicyActivityKey order by dw_loadts) as _valid_to
    from
        filtered
)

select * from ranged