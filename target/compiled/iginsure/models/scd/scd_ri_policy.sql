-- This file is automatically generated

with

ri_policy as (
    select * from "IGI_PROD_DW"."dbo"."RIPolicy"
),

ordered as (
    select
        lRIPolicyKey,
        lRIFolderKey,
        lActiveRIActivityKey,
        nVersion,
        dtPeriodFrom,
        dtPeriodTo,
        nYearOfAccount,
        sReference,
        lRIPolicyCurrencyKey,
        dRIPolicyROE,
        bRenewalCreated,
        lRenewalRIPolicyKey,
        lClosedIntoRIPolicyKey,
        dtClosedIntoDate,
        lImplementationSetupForNewOldRIKey,
        bEnableNewRI,
        bAutoCreated,
        lRIPolicyClosedIntoChainKey,
        lTypeofRIClassKey,
        sSourceReference,
        nUWYear,
        nPML,
        nPMLPerc,
        dw_loadts,
        row_number() over (
            partition by
                lRIPolicyKey,
                lRIFolderKey,
                lActiveRIActivityKey,
                nVersion,
                dtPeriodFrom,
                dtPeriodTo,
                nYearOfAccount,
                sReference,
                lRIPolicyCurrencyKey,
                dRIPolicyROE,
                bRenewalCreated,
                lRenewalRIPolicyKey,
                lClosedIntoRIPolicyKey,
                dtClosedIntoDate,
                lImplementationSetupForNewOldRIKey,
                bEnableNewRI,
                bAutoCreated,
                lRIPolicyClosedIntoChainKey,
                lTypeofRIClassKey,
                sSourceReference,
                nUWYear,
                nPML,
                nPMLPerc
            order by
                dw_loadts
        ) as dw_extract_order
    from
        ri_policy
),

filtered as (
    select * from ordered where dw_extract_order = 1
),

ranged as (
    select
        lRIPolicyKey,
        lRIFolderKey,
        lActiveRIActivityKey,
        nVersion,
        dtPeriodFrom,
        dtPeriodTo,
        nYearOfAccount,
        sReference,
        lRIPolicyCurrencyKey,
        dRIPolicyROE,
        bRenewalCreated,
        lRenewalRIPolicyKey,
        lClosedIntoRIPolicyKey,
        dtClosedIntoDate,
        lImplementationSetupForNewOldRIKey,
        bEnableNewRI,
        bAutoCreated,
        lRIPolicyClosedIntoChainKey,
        lTypeofRIClassKey,
        sSourceReference,
        nUWYear,
        nPML,
        nPMLPerc,
        dw_loadts as _valid_from,
        lead(dw_loadts) over (partition by lRIPolicyKey order by dw_loadts) as _valid_to
    from
        filtered
)

select * from ranged