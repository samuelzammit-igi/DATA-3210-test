-- This file is automatically generated

with

ri_activity as (
    select * from "IGI_PROD_DW"."dbo"."RIActivity"
),

ordered as (
    select
        lRIActivityKey,
        lRIPolicyKey,
        lRIFolderKey,
        lTypeOfPolicyActivityKey,
        lAccountPeriodKey,
        nSequence,
        sReference,
        dtOrderPlaced,
        dtPeriodFrom,
        dtPeriodTo,
        nPeriodDays,
        dtPeriodToTruncated,
        nTermsOfTradeDays,
        dtCancel,
        bEndorsed,
        lReinsuredDivisionKey,
        lUnderwritingAssistContactKey,
        lUnderwriterContactKey,
        lRIActivityCurrencyKey,
        dROE,
        lTypeOfRIPolicyKey,
        lTypeOfClaimBasisKey,
        lTypeOfRIBasisKey,
        lTypeOfRIExpiryKey,
        lTypeOfRICategoryKey,
        dtNoticeOfCancellation,
        nNoticeOfCancellationDays,
        nCountCancellationReason,
        dCessionPC,
        bFixedCession,
        bEnableNewRI,
        bProcessInstalments,
        bGenReversalPropRIAmounts,
        TypeOfEndorsementKey,
        lSubDivisionKey,
        dw_loadts,
        row_number() over (
            partition by
                lRIActivityKey,
                lRIPolicyKey,
                lRIFolderKey,
                lTypeOfPolicyActivityKey,
                lAccountPeriodKey,
                nSequence,
                sReference,
                dtOrderPlaced,
                dtPeriodFrom,
                dtPeriodTo,
                nPeriodDays,
                dtPeriodToTruncated,
                nTermsOfTradeDays,
                dtCancel,
                bEndorsed,
                lReinsuredDivisionKey,
                lUnderwritingAssistContactKey,
                lUnderwriterContactKey,
                lRIActivityCurrencyKey,
                dROE,
                lTypeOfRIPolicyKey,
                lTypeOfClaimBasisKey,
                lTypeOfRIBasisKey,
                lTypeOfRIExpiryKey,
                lTypeOfRICategoryKey,
                dtNoticeOfCancellation,
                nNoticeOfCancellationDays,
                nCountCancellationReason,
                dCessionPC,
                bFixedCession,
                bEnableNewRI,
                bProcessInstalments,
                bGenReversalPropRIAmounts,
                TypeOfEndorsementKey,
                lSubDivisionKey
            order by
                dw_loadts
        ) as dw_extract_order
    from
        ri_activity
),

filtered as (
    select * from ordered where dw_extract_order = 1
),

ranged as (
    select
        lRIActivityKey,
        lRIPolicyKey,
        lRIFolderKey,
        lTypeOfPolicyActivityKey,
        lAccountPeriodKey,
        nSequence,
        sReference,
        dtOrderPlaced,
        dtPeriodFrom,
        dtPeriodTo,
        nPeriodDays,
        dtPeriodToTruncated,
        nTermsOfTradeDays,
        dtCancel,
        bEndorsed,
        lReinsuredDivisionKey,
        lUnderwritingAssistContactKey,
        lUnderwriterContactKey,
        lRIActivityCurrencyKey,
        dROE,
        lTypeOfRIPolicyKey,
        lTypeOfClaimBasisKey,
        lTypeOfRIBasisKey,
        lTypeOfRIExpiryKey,
        lTypeOfRICategoryKey,
        dtNoticeOfCancellation,
        nNoticeOfCancellationDays,
        nCountCancellationReason,
        dCessionPC,
        bFixedCession,
        bEnableNewRI,
        bProcessInstalments,
        bGenReversalPropRIAmounts,
        TypeOfEndorsementKey,
        lSubDivisionKey,
        dw_loadts as _valid_from,
        lead(dw_loadts) over (partition by lRIActivityKey order by dw_loadts) as _valid_to
    from
        filtered
)

select * from ranged