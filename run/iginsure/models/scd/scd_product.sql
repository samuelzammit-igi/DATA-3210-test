create view "dbt_dev"."scd_product__dbt_tmp" as
    -- This file is automatically generated


with

product as (
    select * from "IGI_PROD_DW"."dbo"."PRODUCT"
),

ordered as (
    select
        LPRODUCTKEY,
        SPRODUCTCODE,
        SPRODUCT,
        SPRODUCTSEARCH,
        lTypeOfProductGroupKey,
        bAllowStandardPolicy,
        bAllowAgreement,
        sFormalProductName,
        lActiveVersionCarrierKey,
        lActiveVersionTemplateKey,
        lAccRecFollowUpGroupKey,
        bUseAccountSubmission,
        lPolicySummaryViewScreenKey,
        lWQContainerKey,
        sLOBAccountCode,
        dw_loadts,
        row_number() over (
            partition by
                LPRODUCTKEY,
                SPRODUCTCODE,
                SPRODUCT,
                SPRODUCTSEARCH,
                lTypeOfProductGroupKey,
                bAllowStandardPolicy,
                bAllowAgreement,
                sFormalProductName,
                lActiveVersionCarrierKey,
                lActiveVersionTemplateKey,
                lAccRecFollowUpGroupKey,
                bUseAccountSubmission,
                lPolicySummaryViewScreenKey,
                lWQContainerKey,
                sLOBAccountCode
            order by
                dw_loadts
        ) as dw_extract_order
    from
        product
),

filtered as (
    select * from ordered where dw_extract_order = 1
),

ranged as (
    select
        LPRODUCTKEY,
        SPRODUCTCODE,
        SPRODUCT,
        SPRODUCTSEARCH,
        lTypeOfProductGroupKey,
        bAllowStandardPolicy,
        bAllowAgreement,
        sFormalProductName,
        lActiveVersionCarrierKey,
        lActiveVersionTemplateKey,
        lAccRecFollowUpGroupKey,
        bUseAccountSubmission,
        lPolicySummaryViewScreenKey,
        lWQContainerKey,
        sLOBAccountCode,
        dw_loadts as _valid_from,
        lead(dw_loadts) over (partition by LPRODUCTKEY order by dw_loadts) as _valid_to
    from
        filtered
)

select * from ranged
