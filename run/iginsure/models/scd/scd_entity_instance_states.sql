create view "dbt_dev"."scd_entity_instance_states__dbt_tmp" as
    -- This file is automatically generated


with

entity_instance_states as (
    select * from "IGI_PROD_DW"."dbo"."EntityInstanceStates"
),

ordered as (
    select
        lEntityInstanceStateKey,
        lEntityKey,
        lInstanceKey,
        lEntityStateMemberKey,
        bEntityStatePending,
        lReadBitfield,
        lWriteBitfield,
        dw_loadts,
        row_number() over (
            partition by
                lEntityInstanceStateKey,
                lEntityKey,
                lInstanceKey,
                lEntityStateMemberKey,
                bEntityStatePending,
                lReadBitfield,
                lWriteBitfield
            order by
                dw_loadts
        ) as dw_extract_order
    from
        entity_instance_states
),

filtered as (
    select * from ordered where dw_extract_order = 1
),

ranged as (
    select
        lEntityInstanceStateKey,
        lEntityKey,
        lInstanceKey,
        lEntityStateMemberKey,
        bEntityStatePending,
        lReadBitfield,
        lWriteBitfield,
        dw_loadts as _valid_from,
        lead(dw_loadts) over (partition by lEntityInstanceStateKey order by dw_loadts) as _valid_to
    from
        filtered
)

select * from ranged
